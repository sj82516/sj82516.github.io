<!DOCTYPE html>
<html lang="en"><head>
	
	<meta name="generator" content="Hugo 0.81.0" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="Ruby 提供 Module 用來跨 class reuse code (Mixin)，但如果隨意使用會造成可讀性與維護性困難，淺談問題與分享解法"><meta property="og:title" content="【程式設計】謹慎使用 Mixin - 淺談 RoR Module 使用的陷阱" />
<meta property="og:description" content="Ruby 提供 Module 用來跨 class reuse code (Mixin)，但如果隨意使用會造成可讀性與維護性困難，淺談問題與分享解法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanchieh.page/posts/2022/2022-08-27-%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E8%AC%B9%E6%85%8E%E4%BD%BF%E7%94%A8-mixin-%E6%B7%BA%E8%AB%87-ror-module-%E4%BD%BF%E7%94%A8%E7%9A%84%E9%99%B7%E9%98%B1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-27T01:21:40&#43;00:00" />
<meta property="article:modified_time" content="2022-08-27T01:21:40&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【程式設計】謹慎使用 Mixin - 淺談 RoR Module 使用的陷阱"/>
<meta name="twitter:description" content="Ruby 提供 Module 用來跨 class reuse code (Mixin)，但如果隨意使用會造成可讀性與維護性困難，淺談問題與分享解法"/>

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/all.css" />
	<title>【程式設計】謹慎使用 Mixin - 淺談 RoR Module 使用的陷阱 | Yuanchieh&#39;s Blog</title><meta name="google-site-verification" content="Zmi0DCwmB_paCE45T_J552m4NDDpaMH6dqZLMYgM7Js" />
</head>
<body><header>
	
	<div id="avatar">
		<a href="https://yuanchieh.page">
		  <img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" alt="Yuanchieh&#39;s Blog">
		</a>
	</div>
	
	<div id="titletext"><h2 id="title"><a href="https://yuanchieh.page">Yuanchieh&#39;s Blog</a></h2></div>
	<div id="title-description"><p id="subtitle">生命是長期而持續的累積</p><div id="social">
			<nav>
				<ul>
					<li><a href="https://github.com/sj82516"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="mailto:sj82516@gmail.com"><i title="Email" class="icons fas fa-envelope"></i></a></li>
					<li><a href="/index.xml"><i title="RSS" class="icons fas fa-rss"></i></a></li></ul>
			</nav>
		</div>
	</div>
	
	<div id="mainmenu">
		<nav>
			<ul>
				
				<li><a href="/posts">All Posts</a></li>
				
				<li><a href="/about">About</a></li>
				
				<li><a href="/categories">Categories</a></li>
				
			</ul>
		</nav>
	</div>
	
</header>
<main><div class="post">
	
	<div class="author">
	
	</div>
	<div class="post-header">
	
		<div class="meta">
			
			<div class="date">
				<span class="day">27</span>
				<span class="rest">Aug 2022</span>
			</div>
			
		</div>
		
		<div class="matter">
			<h1 class="title">【程式設計】謹慎使用 Mixin - 淺談 RoR Module 使用的陷阱</h1>
		</div>
	</div>
	<div class="markdown">
		<p>平日在公司使用 RoR 開發，過往 code base 在跨 class 時為了方便會抽出一個名為 <code>XXFunction::SharedMethod</code> 的 module，讓多個 class 直接 include 使用，但後續在閱讀時發現 module 與 class 職責不清楚，導致閱讀時要不斷地多個檔案切換，最可怕是 instance variable 在 module / class 都會讀寫，強耦合的情況下任意的改動都有可能破壞原本的設計</p>
<p>因此有了這篇的文章誕生，探討 Module 在 RoR 中該如何正確地使用，才可以再享有 code reuse 的便利卻不造成可讀性 / 維護性上的困擾</p>
<p>以下文章大量參考</p>
<ul>
<li>Gitlab 上的討論 <a href="https://docs.gitlab.com/ee/development/module_with_instance_variables.html">Rails module using instance variable is harmful</a></li>
<li><a href="https://www.cloudbees.com/blog/good-module-bad-module">Good Module or Bad Module</a></li>
<li><a href="https://www.cloudbees.com/blog/when-to-be-concerned-about-concerns">When To Be Concerned About Concerns</a></li>
</ul>
<h2 id="module-簡介">Module 簡介</h2>
<p>Module 在 Rudy 中是一個類似 class 的存在，是 class / method / constant 的集合但不可以被 initiailize，主要的功能有兩個</p>
<h4 id="1-namespace">1. Namespace</h4>
<p>如果有兩個 class 在不同的 context 中卻有類似的命名，可以用 Module 當作前綴隔開，例如</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">module</span> FeatureA
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Hello</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">module</span> FeatureB
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Hello</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">FeatureA</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Hello</span>
<span style="color:#66d9ef">FeatureB</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Hello</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2-code-reuse">2. Code Reuse</h4>
<p>在 Ruby 中繼承只能夠 <code>單一繼承</code>，另外繼承設計的理念偏向是 <code>is-a</code>，如果想更廣泛的賦予 class 某種能力 <code>could-do</code>，那用 module 的方式會更加的適合，在 module 嵌入的數量上 Ruby 並沒有限制 (參考 <a href="https://railsbook.tw/chapters/08-ruby-basic-4">類別（Class）與模組（Module）</a>)</p>
<p>最基本的例子是 Ruby Core Module <a href="https://ruby-doc.org/core-2.5.0/Comparable.html"><code>Comparable</code></a>，當 class include Module 後只要實作 <code>&lt;=&gt;</code> method，就可以使用 Comparable 定義的功能如 <code>&lt;、&gt;、==、between?</code> 等</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SizeMatters</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Comparable</span>
  <span style="color:#66d9ef">attr</span> <span style="color:#e6db74">:str</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">&lt;=&gt;</span>(other)
    str<span style="color:#f92672">.</span>size <span style="color:#f92672">&lt;=&gt;</span> other<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>size
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(str)
    @str <span style="color:#f92672">=</span> str
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">inspect</span>
    @str
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

s1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">SizeMatters</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;Z&#34;</span>)
s2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">SizeMatters</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;YY&#34;</span>)
s1 <span style="color:#f92672">&lt;</span> s2
</code></pre></td></tr></table>
</div>
</div><h2 id="濫用-module-的壞味道">濫用 Module 的壞味道</h2>
<p>介紹了 Module 的功用，來看一下在濫用的情況下造成的副作用</p>
<h3 id="臭味-1-相依性變成隱式降低易讀性">臭味 1. 相依性變成隱式，降低易讀性</h3>
<p>試想今天只是為了降低 class 的程式碼行數，而單純把 code 抽到 Module 會發生什麼？</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AfterSignupController</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Wicked</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Wizard</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">SetAdmin</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">MailAfterSuccessfulCreate</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">FooBarFighters</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MyHero</span>
  <span style="color:#75715e"># ...</span>
<span style="color:#66d9ef">end</span>
</code></pre></td></tr></table>
</div>
</div><p>打開了一個檔案，結果發現 class 中所有的 method 都在別的 module 內，這時候要找到對應的 module 在哪就很麻煩</p>
<p>更可怕的是當你找到後，你怎麼改保證在有 class 依賴的情況下，改動 Module 會不會壞掉？</p>
<blockquote>
<p><code>Extracting methods into a module to only turn around and include them is worse than pointless.</code> It&rsquo;s actively damaging to the readability of your codebase.</p>
</blockquote>
<h3 id="臭味-2-嚴重耦合如果共用-instance-variable-會讓情況更糟">臭味 2. 嚴重耦合，如果共用 Instance Variable 會讓情況更糟</h3>
<p>分享一下目前遇到的案例</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">module</span> SharedFunction
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_method</span>
        self<span style="color:#f92672">.</span>var <span style="color:#f92672">+=</span> <span style="color:#ae81ff">10</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print</span>
        puts self<span style="color:#f92672">.</span>var <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>var2
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Hello</span>
    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">SharedFunction</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>
        self<span style="color:#f92672">.</span>var <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>var2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
        <span style="color:#f92672">//</span> <span style="color:#960050;background-color:#1e0010">耦合點</span><span style="color:#ae81ff">1</span>: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">必須先</span> initial var<span style="color:#960050;background-color:#1e0010">，否則</span> update_method <span style="color:#960050;background-color:#1e0010">就會出錯</span>
        <span style="color:#e6db74">//</span> <span style="color:#960050;background-color:#1e0010">耦合點</span><span style="color:#ae81ff">2</span>: <span style="color:#960050;background-color:#1e0010">必需要知道</span> <span style="color:#66d9ef">module</span> method <span style="color:#960050;background-color:#1e0010">呼叫順序，變成是要知道</span> module <span style="color:#960050;background-color:#1e0010">所有細節才能使用，缺少封裝的意義</span>
        update_method
        print
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_var</span>
        <span style="color:#e6db74">//</span> <span style="color:#960050;background-color:#1e0010">耦合點</span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span> var <span style="color:#960050;background-color:#1e0010">這邊也有機會變動，未來在找</span> var <span style="color:#960050;background-color:#1e0010">的值到底是什麼會很困難</span>
        self<span style="color:#f92672">.</span>var <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">attr_accessor</span> var
<span style="color:#66d9ef">end</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看出 module 在使用 instance variable 後會有很多耦合的地方，包含 initialzie 的時機 / 暴露過多細節等問題</p>
<h3 id="壞味道3-多個-module-間可能會有命名衝突">壞味道3. 多個 Module 間可能會有命名衝突</h3>
<p>如果今天兩個 Module 命名重複怎麼辦？ 在 Ruby 中會依照繼承鏈決定套用到的 method，但可能不符合 caller 的預期，這邊可以參考前端 React 圈的討論 <a href="https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html">Mixins Considered Harmful</a></p>
<h2 id="如何解決">如何解決</h2>
<h3 id="建議-1-composition-over-inheritance">建議 1. Composition over Inheritance</h3>
<p>Module 某種程度是多重繼承，也可以用 class.ancestors 看到 included Module 在繼承鏈上，要解決這樣的臭味可以改用 <code>Composition</code></p>
<p>Composition 是指說把類似的行為封裝成 class，直接在原本的 class 中使用，這帶來的好處是</p>
<ol>
<li>class 有更好的封裝性，只有 public method 可以被使用 (在 Ruby 中不完全正確)</li>
<li>class 可以獨立測試</li>
</ol>
<p>例如以下，原本 tracking 相關的行為被抽到 module 中，要知道</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Todo</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  <span style="color:#75715e"># Other todo implementation</span>
  <span style="color:#75715e"># ...</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">EventTracking</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">module</span> EventTracking
  <span style="color:#66d9ef">extend</span> <span style="color:#66d9ef">ActiveSupport</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Concern</span>
  included <span style="color:#66d9ef">do</span>
    has_many <span style="color:#e6db74">:events</span>
    before_create <span style="color:#e6db74">:track_creation</span>
    after_destroy <span style="color:#e6db74">:track_deletion</span>
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify_next!</span>
    <span style="color:#75715e">#</span>
  <span style="color:#66d9ef">end</span>
  <span style="color:#66d9ef">private</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">track_creation</span>
      <span style="color:#75715e"># ...</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></td></tr></table>
</div>
</div><p>但現在 tracking 變成 class <code>EventPlanning</code>，好處是不用猜 <code>notify_next!</code> 在哪個 module，職責與細節都封裝在 EventPlanning 裡面，要改動只要確保相依的 class，就不用特別擔心，而且還有測試保護</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Todo</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  <span style="color:#75715e"># Other todo implementation</span>
  <span style="color:#75715e"># ...</span>
  has_many <span style="color:#e6db74">:events</span>
  before_create <span style="color:#e6db74">:track_creation</span>
  after_destroy <span style="color:#e6db74">:track_deletion</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">notify_next!</span>
    <span style="color:#66d9ef">EventPlanning</span><span style="color:#f92672">.</span>new(self<span style="color:#f92672">.</span>events)<span style="color:#f92672">.</span>notify_next!
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="建議-2-設計-module-時有明確的職責並確保暴露的細節">建議 2. 設計 Module 時有明確的職責，並確保暴露的細節</h3>
<p>千萬不要為了 reuse code 而放棄 Object Oriented 的思考，要確保每一個 Module 被設計的含義，具體來說就是</p>
<ol>
<li>include 的 class 必須實作什麼功能 (決定耦合點)</li>
<li>Module 可以提供 class 怎樣的額外功能</li>
</ol>
<p>讓我們看幾個漂亮的 Module 設計</p>
<h4 id="範例enumerable">範例：Enumerable</h4>
<p><a href="https://ruby-doc.org/core-3.1.2/Enumerable.html">Enumerable</a> 是提供集合類型的 class 有方便遍歷 (iterate) 的方法</p>
<ol>
<li>include class 必須實作 <code>each</code></li>
<li>Module 可以提供 class <code>map / select / sort / count</code> 等 iterator 該有的功能</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span>
  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Enumerable</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">each</span>
    <span style="color:#66d9ef">yield</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">yield</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>
    <span style="color:#66d9ef">yield</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">Foo</span><span style="color:#f92672">.</span>new<span style="color:#f92672">.</span>each_entry{ <span style="color:#f92672">|</span>element<span style="color:#f92672">|</span> p element }
</code></pre></td></tr></table>
</div>
</div><p>Enumerable 與 class 耦合點只有 each 這個 method，完全沒有 instance variable 等其他耦合，非常乾淨</p>
<h3 id="建議-3-如果要用-instance-variable-請確保只有-module-自己使用">建議 3. 如果要用 instance variable 請確保只有 Module 自己使用</h3>
<p>如果 Module 還是需要使用 instance variable 也沒關係，確保 class 不會用到即可</p>
<h4 id="範例sidekiqworker">範例：Sidekiq::Worker</h4>
<p>讓我們看一個稍微複雜的案例</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HardWorker</span>
    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Worker</span>
    sidekiq_options <span style="color:#e6db74">queue</span>: <span style="color:#e6db74">&#39;critical&#39;</span>, <span style="color:#66d9ef">retry</span>: <span style="color:#ae81ff">5</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>(<span style="color:#f92672">*</span>args)
        <span style="color:#75715e"># do some work</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">HardWorker</span><span style="color:#f92672">.</span>perform_async(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>)
</code></pre></td></tr></table>
</div>
</div><p>在 include Sidekiq::Worker，可以手動調整參數 sidekiq_options，這邊實作就會建立 instance variable</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb">self<span style="color:#f92672">.</span>sidekiq_options_hash <span style="color:#f92672">=</span> get_sidekiq_options<span style="color:#f92672">.</span>merge(opts)
</code></pre></td></tr></table>
</div>
</div><p>但很明顯這個 variable 在 class 是完全不會用到，只有 module 內部使用，所以沒有問題</p>
<p>另外當我們往下追 perform_async 時，可以看到</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform_inline</span>(<span style="color:#f92672">*</span>args)
    <span style="color:#66d9ef">Setter</span><span style="color:#f92672">.</span>new(self, {})<span style="color:#f92672">.</span>perform_inline(<span style="color:#f92672">*</span>args)
<span style="color:#66d9ef">end</span>
</code></pre></td></tr></table>
</div>
</div><p>這邊出現一個 module 內部定義的 class <code>Setter</code>，可以看到實際發送的邏輯在這邊，透過 class 封裝好處是不怕被其他人不小心複寫或改動</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">module</span> Test
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">module_method</span>
        puts private_method
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">private</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">private_method</span>
        <span style="color:#e6db74">&#34;module private&#34;</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>
    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Test</span>

    <span style="color:#66d9ef">private</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">private_method</span>
        <span style="color:#e6db74">&#34;class private&#34;</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

A<span style="color:#f92672">.</span>new<span style="color:#f92672">.</span>module_method <span style="color:#e6db74">//</span> <span style="color:#e6db74">&#34;class private&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>發現 module 內的 method 被覆寫了，但如果改用 class 指定就不會</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rb" data-lang="rb"><span style="color:#66d9ef">module</span> Test
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">module_method</span>
        puts <span style="color:#66d9ef">ModuleClass</span><span style="color:#f92672">.</span>new<span style="color:#f92672">.</span>private_method
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">private</span>
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ModuleClass</span>
        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">private_method</span>
            <span style="color:#e6db74">&#34;module private&#34;</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>
    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Test</span>

    <span style="color:#66d9ef">private</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">private_method</span>
        <span style="color:#e6db74">&#34;class private&#34;</span>
    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

A<span style="color:#f92672">.</span>new<span style="color:#f92672">.</span>module_method <span style="color:#e6db74">//</span> <span style="color:#e6db74">&#34;module private&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="爭議rails-activesupportconcern">爭議：Rails ActiveSupport::Concern</h2>
<p>ActiveSupport::Concern 是 Rails 中蠻有趣的設計，類似於 Module 但有增加更多的 <code>魔法</code>，可以把太大的 orm class 以 module 的形式分拆出去，算是 orm 版的 Module，在使用的心法與上述雷同，就不贅述，也可以參考 <a href="https://blog.appsignal.com/2020/09/16/rails-concers-to-concern-or-not-to-concern.html">Rails Concerns: To Concern Or Not To Concern</a></p>
<p>基本上也都是提到 <code>如果 module 與 class 產生了 circular dependency</code>，如果有人沒注意到直接改 class，那 module 就可能會壞掉；解法同樣是降低依賴的機會，讓 module 做的事情簡單一些</p>
<h2 id="結語">結語</h2>
<p>Ruby 是一門有趣的物件導向語言，所有的東西都是物件，所以在設計上如果多使用物件導向的思維去設計，會讓程式碼更好維護</p>
<p>另外在 DRY 的原則上，我覺得要小心使用，<code>抽共用看起來避免了重複代碼，但這樣造成了很強的耦合</code>，在理解 Clean Architecture 後會發現很多看似重複都是<code>隱性的重複</code>，其實沒有必要抽共用導致耦合的存在，這點未來有機會再延伸探討</p>
<p>在使用 Module 上，請確保</p>
<ol>
<li>真的需要用 module 在用，否則用 composition + class 會讓生活更簡單</li>
<li>Module 設計上要確定暴露的細解與耦合點</li>
<li>使用 instance variable 要小心，請限縮在 module 內使用</li>
</ol>

	</div>
	
	
	
	
	
	
	
	<div class="tags">
		<div class="taxosfloating_left">
			<p>Categories</p>
		</div>
		<div class="termsfloating_right">
			<p>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<a href="/categories/%e6%87%89%e7%94%a8%e9%96%8b%e7%99%bc/"> 應用開發 </a>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			</p>
		</div>
		<div class="clearit"></div>
		
		
		
		
	
		
	
		
		
	</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
	(function() {
	    
	    
	    if (window.location.hostname == "localhost")
	        return;
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    var disqus_shortname = 'yuanchieh';
	    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to load the comments.</noscript>


</div>

  </main>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-82837682-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>
