<!DOCTYPE html>
<html lang="en"><head>
	
	<meta name="generator" content="Hugo 0.81.0" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="目前聽過幾個不同版本的 Clean Architecture 實作，最有趣的地方莫過於在外層在與 usecase 層互動時該採用什麼方式，以下整理出幾種不同模式"><meta property="og:title" content="淺談 Clean Architecture 實作 - Port Mapping 方式" />
<meta property="og:description" content="目前聽過幾個不同版本的 Clean Architecture 實作，最有趣的地方莫過於在外層在與 usecase 層互動時該採用什麼方式，以下整理出幾種不同模式" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanchieh.page/posts/2022/2022-09-11-%E6%B7%BA%E8%AB%87-clean-architecture-%E5%AF%A6%E4%BD%9C-port-mapping-%E6%96%B9%E5%BC%8F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-11T01:21:40&#43;00:00" />
<meta property="article:modified_time" content="2022-09-11T01:21:40&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="淺談 Clean Architecture 實作 - Port Mapping 方式"/>
<meta name="twitter:description" content="目前聽過幾個不同版本的 Clean Architecture 實作，最有趣的地方莫過於在外層在與 usecase 層互動時該採用什麼方式，以下整理出幾種不同模式"/>

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/all.css" />
	<title>淺談 Clean Architecture 實作 - Port Mapping 方式 | Yuanchieh&#39;s Blog</title><meta name="google-site-verification" content="Zmi0DCwmB_paCE45T_J552m4NDDpaMH6dqZLMYgM7Js" />
</head>
<body><header>
	
	<div id="avatar">
		<a href="https://yuanchieh.page">
		  <img src="https://avatars0.githubusercontent.com/u/6858460?s=460&amp;v=4" alt="Yuanchieh&#39;s Blog">
		</a>
	</div>
	
	<div id="titletext"><h2 id="title"><a href="https://yuanchieh.page">Yuanchieh&#39;s Blog</a></h2></div>
	<div id="title-description"><p id="subtitle">生命是長期而持續的累積</p><div id="social">
			<nav>
				<ul>
					<li><a href="https://github.com/sj82516"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="mailto:sj82516@gmail.com"><i title="Email" class="icons fas fa-envelope"></i></a></li>
					<li><a href="/index.xml"><i title="RSS" class="icons fas fa-rss"></i></a></li></ul>
			</nav>
		</div>
	</div>
	
	<div id="mainmenu">
		<nav>
			<ul>
				
				<li><a href="/posts">All Posts</a></li>
				
				<li><a href="/about">About</a></li>
				
				<li><a href="/categories">Categories</a></li>
				
			</ul>
		</nav>
	</div>
	
</header>
<main><div class="post">
	
	<div class="author">
	
	</div>
	<div class="post-header">
	
		<div class="meta">
			
			<div class="date">
				<span class="day">11</span>
				<span class="rest">Sep 2022</span>
			</div>
			
		</div>
		
		<div class="matter">
			<h1 class="title">淺談 Clean Architecture 實作 - Port Mapping 方式</h1>
		</div>
	</div>
	<div class="markdown">
		<p>在一月初時上 Teddy 的 DDD 課程時，第一次見識到 DDD 結合 Clean Architecture，可以將設計跟實作完美的結合，打造出彈性、易懂、好維護的程式碼，就一直對 Clean Architecture 很感興趣 (<a href="https://gitlab.com/-/ide/project/TeddyChen/dddcleankanban/tree/master/-/board/">課程 ezKanban 原始碼</a>)；<br>
後來在 2022 Coscup 上聽到強者 Jalex 分享 <a href="https://slides.com/jalex-chang/go-clean-arch-cresclab">Clean Architecture in Go: The Crescendo Way</a> 提供了另一種實作的方式；<br>
最後在看【Clean Architecture 實作篇】時，作者又提供另一種方式以六角架構為基底的實作</p>
<p>在看了這幾種不同實作的角度後，整理一下實作 Clean Architecture 中不同層轉換的取捨</p>
<h2 id="clean-architecture-的解讀">Clean Architecture 的解讀</h2>
<p>【Clean Architecture】一書談了非常多的觀念，整理後自己的解讀是 <code>架構是為了降低後續的開發、維運成本並最大化工程師的產能</code>，而在這樣的原則下提出了以下的依賴原則</p>
<p><img src="/posts/2022/img/0911/dep.png" alt=""></p>
<ol>
<li>離 IO 越遠的元件越是核心，而核心不應該因為外層的改變而受到影響，就好比說用戶不會在意資料庫是用 MySQL 還是 MongoDB (IO)，他只會在意他購買的品項與折扣對不對 (業務規則)</li>
<li>依賴的物件不可以跨層，所以 Adapter 不能直接存取 Entity</li>
</ol>
<p>所以從內而外，可以分成 Entity (Domain Object) / Use Case / Adapter (Controller, Gateway, Repository - 常指 DB 儲存層) 等</p>
<h3 id="六角架構">六角架構</h3>
<p><img src="/posts/2022/img/0911/hex.png" alt="">
由 Alistair Cockburn 提出的六角架構，剛好與 Clean Architecture 觀點呼應，外部 IO (Adapter) 如果要與內層 (Entity / Use Case) 互動必須通過 <code>Port</code>，這些 Port 會透過依賴反轉當作隔離層，避免內層被外層的變動而改變</p>
<p>Port 方向依照核心的對應有兩種</p>
<ol>
<li>In 從外層呼叫核心</li>
<li>Out 核心呼叫外層 (透過 interface)</li>
</ol>
<h2 id="跨層的溝通原則">跨層的溝通原則</h2>
<p>在【Clean Architecture】一書中，提到如果跨層的話<code>內層的物件是不可以直接被輸出到更外層</code>，例如 Entity 只能在 Use Case 使用，如果要傳到 Controller , Gateway，必須再轉一層 DTO (data to object)，反之從外層往內傳也是，這是為了符合 <code>SRP 單一職責</code></p>
<p>例如一般的 web request，會從 Controller 取得參數 -&gt; Use Case + Entity 處理業務邏輯 -&gt; Controller 回傳結果，此時如果 Controller 在顯示結果直接依賴於 Entity，那 Entity 就會可能因為 API 要多回傳某個欄位而受到改動，違反最一開始的原則</p>
<p>但是如果每一層之間都需要 DTO 轉換，那程式碼會很多重複宣告，因為我們透過<code>重複取代耦合</code>，在【Clean Architecture 實作篇】有整理幾種方式，供大家取捨</p>
<h3 id="1-no-mapping-跨層不轉換">1. No Mapping 跨層不轉換</h3>
<p><img src="/posts/2022/img/0911/no_mapping.jpeg" alt="">
先看跨層完全不轉換的方式，參考我用 golang 實作的版本 <a href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/no-mapping/internal">github/no-mapping</a>，這邊我的 Entity 宣告混雜了 Controller 的 json tag 與 ORM 的 tag</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Entity
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Order</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Model</span>
	<span style="color:#a6e22e">ID</span>        <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;id&#34; gorm:&#34;autoincrement&#34;`</span>
	<span style="color:#a6e22e">Price</span>     <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;price&#34;`</span>
	<span style="color:#a6e22e">Count</span>     <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;count&#34;`</span>
	<span style="color:#a6e22e">Total</span>     <span style="color:#66d9ef">float64</span>
	<span style="color:#a6e22e">CreatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}

<span style="color:#75715e">// Use Case
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">CreateOrderService</span>) <span style="color:#a6e22e">Action</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span> {
	<span style="color:#a6e22e">withTax</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1.1</span>
	<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Total</span> = float64(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Count</span><span style="color:#f92672">*</span><span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Price</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">withTax</span>
	<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">CreatedAt</span> = <span style="color:#a6e22e">now</span>()
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">saveOrder</span>.<span style="color:#a6e22e">SaveOrder</span>(<span style="color:#a6e22e">o</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">o</span>
}
</code></pre></td></tr></table>
</div>
</div><p>在後續的 Controller / Gateway 中，就直接使用 Entity</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Repo 儲存資料
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">OrderRepository</span>) <span style="color:#a6e22e">SaveOrder</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>) {
	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">o</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Error</span>)
}

<span style="color:#75715e">// Controller 直接用 Entity 取得 API request 內容
</span><span style="color:#75715e">// 並傳入 UseCase 中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">OrderController</span>) <span style="color:#a6e22e">CreateOrder</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srv</span> = <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">NewCreateOrder</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">repo</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">order</span> <span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ShouldBindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">order</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>})
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Action</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">order</span>)

	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;total&#34;</span>: <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">Total</span>})
}
</code></pre></td></tr></table>
</div>
</div><h4 id="優缺點">優缺點</h4>
<p>如果是很單純的 CRUD，API / DB 的資料格式都一模一樣才會使用，減少不必要的跨層轉換；</p>
<p>但缺點是如果 API / DB 格式開始分歧，Entity 就會受到污染，出現部分欄位只有在特定用途使用，而不是跟業務邏輯有關，就像是 CreatedAt 欄位只是為了 DB 紀錄，卻出現在業務邏輯上不太合理；<br>
再加上如果未來不用 json 而走 gRPC，那 Entity 就要重新改 tag，因為 IO 變化而改動 Entity 違反了 Clean Architecture 原則</p>
<p>所以建議還是少用</p>
<h3 id="2-two-way-mapping">2. Two way mapping</h3>
<p><img src="/posts/2022/img/0911/two-way_mapping.jpeg" alt="">
<a href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/two-way-mapping">github/two-way mapping</a> 則是 Controller / Gateway 獨立宣告自己的物件，建立出 Entity後再傳入 Use Case 中</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Order</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Price</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Total</span> <span style="color:#66d9ef">float64</span>
}
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">//  Repo  獨立 DAO 定義
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">OrderDAO</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Id</span>        <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`gorm:&#34;autoincrement&#34;`</span>
	<span style="color:#a6e22e">Price</span>     <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Count</span>     <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Total</span>     <span style="color:#66d9ef">float64</span>
	<span style="color:#a6e22e">CreatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">OrderRepository</span>) <span style="color:#a6e22e">SaveOrder</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>) {
    <span style="color:#75715e">// 用 Entity 去轉換 DAO
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">orderDao</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">OrderDAO</span>{
		<span style="color:#a6e22e">Price</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Price</span>,
		<span style="color:#a6e22e">Count</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Count</span>,
		<span style="color:#a6e22e">Total</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Total</span>,
	}

	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">orderDao</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Error</span>)
}

<span style="color:#75715e">// Controller 獨立 Request Object
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">OrderController</span>) <span style="color:#a6e22e">CreateOrder</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srv</span> = <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">NewCreateOrder</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">repo</span>)

    <span style="color:#75715e">// 獨立 DTO 
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CreateOrderRequest</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Price</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;price&#34;`</span>
		<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;count&#34;`</span>
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">o</span> <span style="color:#a6e22e">CreateOrderRequest</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ShouldBindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">o</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>})
		<span style="color:#66d9ef">return</span>
	}

    <span style="color:#75715e">// DTO 重建 Entity
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">order</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>{<span style="color:#a6e22e">Price</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Price</span>, <span style="color:#a6e22e">Count</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Count</span>}
	<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Action</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">order</span>)

	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;total&#34;</span>: <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">Total</span>})
}
</code></pre></td></tr></table>
</div>
</div><p>可以看到 Entity 變得很乾淨，而 Controller / Gateway 要自己負責 DTO 的轉換，讓職責變得更明確</p>
<h4 id="優缺點-1">優缺點</h4>
<p>這算是蠻平衡的設計方式，適合用在 <code>Use Case -&gt; Adapter</code> 這一層，可以看到 Jalex 大大在 DB 儲存層是用 Two way mapping 的方式 <a href="https://github.com/chatbotgang/go-clean-arch/blob/develop/internal/adapter/repository/postgres/good_repository.go">go-clean-arch</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// DAO 另外定義
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">repoGood</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ID</span>        <span style="color:#66d9ef">int</span>       <span style="color:#e6db74">`db:&#34;id&#34;`</span>
	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span>    <span style="color:#e6db74">`db:&#34;name&#34;`</span>
	<span style="color:#a6e22e">OwnerID</span>   <span style="color:#66d9ef">int</span>       <span style="color:#e6db74">`db:&#34;owner_id&#34;`</span>
	<span style="color:#a6e22e">CreatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#e6db74">`db:&#34;created_at&#34;`</span>
	<span style="color:#a6e22e">UpdatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#e6db74">`db:&#34;updated_at&#34;`</span>
}

<span style="color:#75715e">// 直接拿 Good (Entity) 當作參數
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PostgresRepository</span>) <span style="color:#a6e22e">updateGood</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">db</span> <span style="color:#a6e22e">sqlContextGetter</span>, <span style="color:#a6e22e">good</span> <span style="color:#a6e22e">barter</span>.<span style="color:#a6e22e">Good</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">barter</span>.<span style="color:#a6e22e">Good</span>, <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Error</span>) {
	<span style="color:#a6e22e">where</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sq</span>.<span style="color:#a6e22e">And</span>{
		<span style="color:#a6e22e">sq</span>.<span style="color:#a6e22e">Eq</span>{<span style="color:#a6e22e">repoColumnGood</span>.<span style="color:#a6e22e">ID</span>: <span style="color:#a6e22e">good</span>.<span style="color:#a6e22e">ID</span>},
	}

	<span style="color:#a6e22e">update</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}{
		<span style="color:#a6e22e">repoColumnGood</span>.<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">good</span>.<span style="color:#a6e22e">Name</span>,
		<span style="color:#a6e22e">repoColumnGood</span>.<span style="color:#a6e22e">OwnerID</span>:   <span style="color:#a6e22e">good</span>.<span style="color:#a6e22e">OwnerID</span>,
		<span style="color:#a6e22e">repoColumnGood</span>.<span style="color:#a6e22e">UpdatedAt</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>(),
	}

	<span style="color:#75715e">// build SQL query
</span><span style="color:#75715e"></span>	<span style="color:#f92672">...</span>..

	<span style="color:#75715e">// execute SQL query
</span><span style="color:#75715e"></span>	<span style="color:#f92672">...</span>..

	<span style="color:#a6e22e">updatedGood</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">barter</span>.<span style="color:#a6e22e">Good</span>(<span style="color:#a6e22e">row</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">updatedGood</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></td></tr></table>
</div>
</div><h3 id="3-full-mapping">3. Full Mapping</h3>
<p><img src="/posts/2022/img/0911/full_mapping.jpeg" alt="">
<a href="https://github.com/sj82516/clean-architecture-mapping/tree/feat/full-mapping">github/full-mapping</a> 這次嚴格遵守 Clean Architecture，在 two-mapping 上增加<code>跨層都要有 DTO 的轉換</code>，所以 Controller -&gt; Use Case 不能直接用 Entity，多宣告一個 Command Object</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// CreateOrder Use Case 改吃 CreateOrderCommand 當作參數而非 Entity
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CreateOrder</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Action</span>(<span style="color:#a6e22e">command</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CreateOrderCommand</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">domain</span>.<span style="color:#a6e22e">Order</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CreateOrderCommand</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Price</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">// Command 可以負責驗證參數
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewCreateOrderCommand</span>(<span style="color:#a6e22e">price</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">count</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">CreateOrderCommand</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">price</span> &lt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">count</span> &lt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CreateOrderCommand</span>{}, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;params error&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CreateOrderCommand</span>{
		<span style="color:#a6e22e">Price</span>: <span style="color:#a6e22e">price</span>,
		<span style="color:#a6e22e">Count</span>: <span style="color:#a6e22e">count</span>,
	}, <span style="color:#66d9ef">nil</span>
}
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Controller 呼叫 Command Object
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">OrderController</span>) <span style="color:#a6e22e">CreateOrder</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">srv</span> = <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">NewCreateOrder</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">repo</span>)

	<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CreateOrderRequest</span> <span style="color:#66d9ef">struct</span> {
		<span style="color:#a6e22e">Price</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;price&#34;`</span>
		<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;count&#34;`</span>
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">o</span> <span style="color:#a6e22e">CreateOrderRequest</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">ShouldBindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">o</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>})
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">CreateOrderCommand</span>{<span style="color:#a6e22e">Price</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Price</span>, <span style="color:#a6e22e">Count</span>: <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Count</span>}
	<span style="color:#a6e22e">order</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Action</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>)

	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;total&#34;</span>: <span style="color:#a6e22e">order</span>.<span style="color:#a6e22e">Total</span>})
}
</code></pre></td></tr></table>
</div>
</div><h4 id="優缺點-2">優缺點</h4>
<p>多了一個 CreateOrderCommand 最大好處是可以進一步分散職責，由 Port 物件協助<code>驗證資料</code>，這樣 Use Case 可以專心驗證業務規則，而基本的資料驗證可以由 Port (也就是 CreateOrderCommand) 負責</p>
<p>其他地方驗證資料的考量點</p>
<ol>
<li>Use Case: 要驗證資料同時驗證業務規則，這樣會比較複雜，讓 Use Case 專注業務規則會比較好</li>
<li>Controller: 不適合驗證資料，如果有其他地方要呼叫 Use Case 那驗證規則要在重複寫一次</li>
</ol>
<blockquote>
<p>資料驗證 vs 業務規則<br>
業務規則通常指的是與 Entity 本身狀態有關，例如 <code>轉帳餘額不可為空</code>，至於資料驗證比較是一般性的規則檢查例如 Email 格式、金額不可小於零等</p>
</blockquote>
<p>缺點就是如果是 CRUD 的話 DTO 會寫起來很瑣碎，建議是在 Controller -&gt; Use Case 這一層使用</p>
<h3 id="小作弊">小作弊</h3>
<p>上述的案例我們只有管 <code>input port</code>，當 Controller 要呼叫 Use Case 時 Input 用獨立的 Command Object</p>
<p>但是 Use Case 回傳給 Controller 還是用 Entity，這還是違反了 Clean Architecture 物件不可跨層原則，這邊主要是方便使用，這也是【Clean Architecture 實作篇】作者在 p. 112 建議的做法</p>
<p>如果 in / out port 的輸入輸出都要有 DTO，建議參考 Teddy 的實做 <a href="https://gitlab.com/TeddyChen/dddcleankanban/-/blob/master/board/src/main/java/ntut/csie/sslab/kanban/board/usecase/service/GetBoardContentService.java">dddcleankanban</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 在 Use Case 中回傳 output 而非 Entity
</span><span style="color:#75715e"></span>output<span style="color:#f92672">.</span><span style="color:#a6e22e">setBoardId</span><span style="color:#f92672">(</span>input<span style="color:#f92672">.</span><span style="color:#a6e22e">getBoardId</span><span style="color:#f92672">())</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">setBoardMemberDtos</span><span style="color:#f92672">(</span>boardMemberDtos<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">setWorkflowDtos</span><span style="color:#f92672">(</span>workflowDtos<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">setCommittedWorkflowDtos</span><span style="color:#f92672">(</span>committedWorkflowDtos<span style="color:#f92672">)</span>
    <span style="color:#f92672">.</span><span style="color:#a6e22e">setCardDtos</span><span style="color:#f92672">(</span>cardDtosInBoard<span style="color:#f92672">);</span>

<span style="color:#66d9ef">return</span> output
</code></pre></td></tr></table>
</div>
</div><h2 id="總結">總結</h2>
<p><img src="/posts/2022/img/0911/overview.png" alt="">
總結整體架構大致是</p>
<ol>
<li>Controller 有獨立的 Request / Response Object</li>
<li>Controller 會去建立 In Port Command，並呼叫 Use Case</li>
<li>Use Case 實作 In Port Interface，外界是與 Interface 相依</li>
<li>透過 Out Port 與 Repository 溝通</li>
<li>Repository 定義 DAO 儲存資料到 DB</li>
<li>因為 return 都偷懶用 Entity，所以大家都與 Entity 相依</li>
</ol>
<p>採用 Clean Architecture 可以讓每一層變得更獨立、更好測試，開發的模式也可以更固定，在團隊增加人數時也更好上手，增加生產力</p>
<p>剛好公司的專案一邊是 Rails，框架本身就帶有很強烈的架構風格；另一邊微服務用 Golang 實作 Clean Architecture 試著讓框架與架構解耦，算是蠻有趣的衝突與相互印證</p>

	</div>
	
	
	
	
	
	
	
	<div class="tags">
		<div class="taxosfloating_left">
			<p>Categories</p>
		</div>
		<div class="termsfloating_right">
			<p>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<a href="/categories/%e6%9e%b6%e6%a7%8b%e8%a8%ad%e8%a8%88/"> 架構設計 </a>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			</p>
		</div>
		<div class="clearit"></div>
		
		
		
		
	
		
	
		
		
	</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
	(function() {
	    
	    
	    if (window.location.hostname == "localhost")
	        return;
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    var disqus_shortname = 'yuanchieh';
	    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to load the comments.</noscript>


</div>

  </main>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-82837682-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>
